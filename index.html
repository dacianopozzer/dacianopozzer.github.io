<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maison VTO | Lab Interface</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts: Playfair (Editorial), Inter (UI), JetBrains Mono (Technical) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --font-display: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
            --font-tech: 'JetBrains Mono', monospace;
        }
        
        body { font-family: var(--font-body); background-color: #F8F8F8; color: #111; }
        .serif { font-family: var(--font-display); }
        .mono { font-family: var(--font-tech); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #E5E5E5; }
        ::-webkit-scrollbar-thumb:hover { background: #999; }

        /* Loader Animation */
        .scan-line {
            width: 100%;
            height: 2px;
            background: #000;
            position: absolute;
            top: 0;
            left: 0;
            animation: scan 2s linear infinite;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Selection Ring */
        .ring-offset-2 { outline: 2px solid #000; outline-offset: 2px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">

    <!-- HEADER: System Control -->
    <header class="h-auto border-b border-gray-200 bg-white z-30 shrink-0 flex flex-col md:flex-row">
        <!-- Brand -->
        <div class="p-4 md:w-64 border-b md:border-b-0 md:border-r border-gray-200 flex flex-col justify-center">
            <h1 class="text-xl font-semibold tracking-tight serif italic">Maison VTO</h1>
            <p class="text-[10px] text-gray-500 mt-1 leading-tight">
                Plataforma de prova virtual generativa com análise de impacto ambiental.
            </p>
        </div>

        <!-- Controls -->
        <div class="flex-1 p-4 flex flex-col md:flex-row items-start md:items-center gap-6 overflow-x-auto">
            
            <!-- Model Select -->
            <div class="flex flex-col gap-1">
                <label class="text-[9px] uppercase tracking-widest text-gray-400 font-bold">Inference Model</label>
                <select id="modelSelect" class="bg-gray-50 border border-gray-200 text-xs p-1.5 w-40 mono focus:border-black outline-none rounded-sm">
                    <option value="idm-vton">IDM-VTON (Standard)</option>
                    <option value="flux-1">Flux.1 Pro (High-Res)</option>
                    <option value="sdxl">SDXL Lightning (Fast)</option>
                </select>
            </div>

            <!-- API Key -->
            <div class="flex flex-col gap-1 flex-1 w-full md:w-auto">
                <label class="text-[9px] uppercase tracking-widest text-gray-400 font-bold">Gemini API Key</label>
                <div class="flex items-center gap-2">
                    <input type="password" id="apiKey" placeholder="Cole sua chave aqui..." class="bg-gray-50 border border-gray-200 text-xs p-1.5 flex-1 md:w-64 mono focus:border-black outline-none rounded-sm transition-colors">
                    <div class="flex items-center gap-1.5 px-2 py-1 bg-green-50 border border-green-100 rounded-sm">
                        <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-[9px] text-green-700 font-bold tracking-wide">SYSTEM READY</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN GRID layout -->
    <div class="flex-1 grid grid-cols-1 md:grid-cols-3 overflow-hidden">
        
        <!-- COL 1: INPUT (The User) -->
        <section class="border-b md:border-b-0 md:border-r border-gray-200 bg-white flex flex-col overflow-y-auto">
            <div class="sticky top-0 bg-white/95 backdrop-blur z-10 p-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="mono text-xs font-bold uppercase tracking-widest text-gray-400">01. SOURCE</h2>
                <i data-lucide="user" class="w-4 h-4 text-gray-300"></i>
            </div>

            <div class="p-6 flex-1 flex flex-col">
                <div class="relative w-full aspect-[3/4] bg-gray-50 border-2 border-dashed border-gray-200 hover:border-gray-400 transition-colors group cursor-pointer overflow-hidden rounded-sm">
                    <input type="file" id="userUpload" class="absolute inset-0 opacity-0 cursor-pointer z-20" accept="image/*">
                    <img id="userPreview" class="hidden w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500">
                    
                    <div id="userPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none">
                        <span class="serif italic text-2xl text-gray-800 mb-2">Você</span>
                        <span class="mono text-[10px] uppercase border border-gray-200 bg-white px-2 py-1">Upload Foto</span>
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-gray-50 text-[10px] text-gray-500 leading-relaxed border border-gray-100">
                    <strong class="text-gray-900 block mb-1">Dica de Upload:</strong>
                    Para melhores resultados, use uma foto de corpo inteiro com fundo neutro e iluminação frontal. Evite roupas muito largas que ocultem a silhueta.
                </div>
            </div>
        </section>

        <!-- COL 2: SELECTION (The Product) -->
        <section class="border-b md:border-b-0 md:border-r border-gray-200 bg-gray-50 flex flex-col overflow-y-auto">
            <div class="sticky top-0 bg-gray-50/95 backdrop-blur z-10 p-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="mono text-xs font-bold uppercase tracking-widest text-gray-400">02. SELECTION</h2>
                <div class="relative w-40">
                    <input type="text" id="productSearch" placeholder="Search..." class="w-full bg-white border border-gray-200 pl-2 pr-2 py-1 text-xs mono focus:border-black outline-none">
                </div>
            </div>

            <div id="productGrid" class="p-6 grid grid-cols-2 gap-4 content-start">
                <!-- Products injected via JS -->
            </div>
            
            <!-- Pagination -->
            <div class="mt-auto p-4 border-t border-gray-200 flex justify-between items-center text-[10px] mono bg-gray-50 sticky bottom-0">
                <button id="prevPage" class="hover:underline disabled:opacity-30">PREV</button>
                <span id="pageIndicator">1/1</span>
                <button id="nextPage" class="hover:underline disabled:opacity-30">NEXT</button>
            </div>
        </section>

        <!-- COL 3: CONFIG & OUTPUT (The Lab) -->
        <section class="bg-white flex flex-col overflow-y-auto">
            <div class="sticky top-0 bg-white/95 backdrop-blur z-10 p-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="mono text-xs font-bold uppercase tracking-widest text-gray-400">03. GENERATION</h2>
                <i data-lucide="cpu" class="w-4 h-4 text-gray-300"></i>
            </div>

            <div class="p-6 space-y-8">
                
                <!-- Selected Summary -->
                <div id="selectionSummary" class="hidden fade-in p-4 border border-gray-100 bg-gray-50/50">
                    <h3 class="mono text-[10px] uppercase text-gray-400 mb-2">Target Selection</h3>
                    <div class="flex gap-4">
                        <img id="summaryProductImg" class="w-12 h-16 object-cover border border-gray-200">
                        <div>
                            <div class="serif text-lg leading-none italic" id="summaryProductName">-</div>
                            <div class="mono text-xs text-gray-500 mt-1" id="summaryProductPrice">-</div>
                        </div>
                    </div>
                </div>

                <!-- Config Controls -->
                <div class="space-y-4 opacity-50 pointer-events-none transition-opacity duration-300" id="configPanel">
                    
                    <!-- Output Mode -->
                    <div>
                        <label class="mono text-[9px] uppercase font-bold text-gray-400 mb-2 block">Output Format</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setMode('image')" id="btnModeImage" class="border border-black bg-black text-white py-2 text-xs mono flex items-center justify-center gap-2">
                                <i data-lucide="image" class="w-3 h-3"></i> PHOTO
                            </button>
                            <button onclick="setMode('video')" id="btnModeVideo" class="border border-gray-200 text-gray-400 hover:border-black hover:text-black py-2 text-xs mono flex items-center justify-center gap-2 transition-colors">
                                <i data-lucide="video" class="w-3 h-3"></i> 360° VIDEO
                            </button>
                        </div>
                    </div>

                    <!-- Generate Action -->
                    <div>
                        <button id="generateBtn" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white mono text-xs uppercase tracking-widest transition-all shadow-lg shadow-blue-900/10 flex items-center justify-center gap-2 group">
                            <i data-lucide="zap" class="w-4 h-4 group-hover:text-yellow-300 transition-colors"></i> 
                            Run Inference
                        </button>
                        <div class="flex justify-between mt-2 text-[9px] mono text-gray-400">
                            <span>EST. COST: <span id="estCost">$0.0012</span></span>
                            <span>EST. TIME: <span id="estTime">2.4s</span></span>
                        </div>
                    </div>
                </div>
                
                <div id="emptyStateConfig" class="text-center py-10 text-gray-300">
                    <p class="mono text-xs">SELECT USER & PRODUCT TO UNLOCK</p>
                </div>

                <!-- HISTORY / OUTPUT STREAM -->
                <div class="border-t border-gray-100 pt-6">
                    <h3 class="mono text-[10px] uppercase text-gray-400 mb-4 font-bold">Output Stream</h3>
                    <div id="outputStream" class="space-y-6">
                        <!-- Generated Results Go Here -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Gemini Modal (Bottom Sheet style) -->
    <div id="geminiPanel" class="hidden fixed bottom-4 right-4 md:right-8 w-[calc(100%-2rem)] md:w-96 bg-white shadow-2xl border border-gray-200 z-50 fade-in rounded-sm">
        <div class="bg-gray-900 text-white p-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="sparkles" class="w-3 h-3 text-blue-400"></i>
                <span class="mono text-xs uppercase tracking-widest">AI Consultant</span>
            </div>
            <button onclick="document.getElementById('geminiPanel').classList.add('hidden')" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-3 h-3"></i></button>
        </div>
        <div class="p-4">
            <div id="geminiContent" class="text-xs font-serif leading-relaxed text-gray-600 min-h-[40px]"></div>
            <button id="askGeminiBtn" class="mt-3 w-full border border-gray-200 py-2 text-[10px] mono uppercase hover:bg-gray-50 transition-colors">
                Analyze Generated Look
            </button>
        </div>
    </div>

    <script>
        // --- DATA ---
        const PRODUCTS = [
            { id: 1, name: "Silk Charmeuse", price: 295, img: "https://images.unsplash.com/photo-1551163943-3f6a29e39bb7?w=400&auto=format&fit=crop&q=60" },
            { id: 2, name: "Wool Blazer", price: 550, img: "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?w=400&auto=format&fit=crop&q=60" },
            { id: 3, name: "Cashmere Turtleneck", price: 180, img: "https://images.unsplash.com/photo-1576566588028-4147f3842f27?w=400&auto=format&fit=crop&q=60" },
            { id: 4, name: "Pleated Skirt", price: 220, img: "https://images.unsplash.com/photo-1583496661160-fb5886a0aaaa?w=400&auto=format&fit=crop&q=60" },
            { id: 5, name: "Linen Dress", price: 150, img: "https://images.unsplash.com/photo-1596783074918-c84cb06531ca?w=400&auto=format&fit=crop&q=60" },
            { id: 6, name: "Denim Jacket", price: 110, img: "https://images.unsplash.com/photo-1523381210434-271e8be1f52b?w=400&auto=format&fit=crop&q=60" },
        ];

        // --- STATE ---
        let state = {
            userImg: null,
            selectedProduct: null,
            mode: 'image', // 'image' | 'video'
            history: [],
            isGenerating: false,
            search: ''
        };

        // --- DOM ---
        const els = {
            userUpload: document.getElementById('userUpload'),
            userPreview: document.getElementById('userPreview'),
            userPlaceholder: document.getElementById('userPlaceholder'),
            productGrid: document.getElementById('productGrid'),
            configPanel: document.getElementById('configPanel'),
            emptyConfig: document.getElementById('emptyStateConfig'),
            summary: document.getElementById('selectionSummary'),
            sumImg: document.getElementById('summaryProductImg'),
            sumName: document.getElementById('summaryProductName'),
            sumPrice: document.getElementById('summaryProductPrice'),
            genBtn: document.getElementById('generateBtn'),
            outputStream: document.getElementById('outputStream'),
            geminiPanel: document.getElementById('geminiPanel'),
            geminiContent: document.getElementById('geminiContent'),
            askGeminiBtn: document.getElementById('askGeminiBtn'),
            apiKey: document.getElementById('apiKey'),
            search: document.getElementById('productSearch'),
            btnImg: document.getElementById('btnModeImage'),
            btnVid: document.getElementById('btnModeVideo'),
            estCost: document.getElementById('estCost'),
            estTime: document.getElementById('estTime')
        };

        // --- INIT ---
        lucide.createIcons();
        renderProducts();

        // --- EVENT HANDLERS ---
        els.userUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    state.userImg = ev.target.result;
                    els.userPreview.src = state.userImg;
                    els.userPreview.classList.remove('hidden');
                    els.userPlaceholder.classList.add('hidden');
                    checkReadiness();
                };
                reader.readAsDataURL(file);
            }
        });

        els.search.addEventListener('input', (e) => {
            state.search = e.target.value.toLowerCase();
            renderProducts();
        });

        els.genBtn.addEventListener('click', startSimulation);
        els.askGeminiBtn.addEventListener('click', callGemini);

        // --- FUNCTIONS ---

        function setMode(mode) {
            state.mode = mode;
            const active = "border-black bg-black text-white".split(' ');
            const inactive = "border-gray-200 text-gray-400 hover:border-black hover:text-black".split(' ');
            
            if (mode === 'image') {
                els.btnImg.classList.add(...active);
                els.btnImg.classList.remove(...inactive.filter(c => !c.includes('hover')));
                els.btnVid.classList.remove(...active);
                els.btnVid.classList.add(...inactive);
                
                els.estCost.textContent = "$0.0012";
                els.estTime.textContent = "2.4s";
            } else {
                els.btnVid.classList.add(...active);
                els.btnVid.classList.remove(...inactive.filter(c => !c.includes('hover')));
                els.btnImg.classList.remove(...active);
                els.btnImg.classList.add(...inactive);
                
                els.estCost.textContent = "$0.0450";
                els.estTime.textContent = "12.8s";
            }
        }
        window.setMode = setMode;

        function renderProducts() {
            const filtered = PRODUCTS.filter(p => p.name.toLowerCase().includes(state.search));
            
            els.productGrid.innerHTML = filtered.map(p => `
                <div onclick="selectProduct(${p.id})" class="cursor-pointer group relative">
                    <div class="aspect-[3/4] bg-gray-100 mb-2 relative overflow-hidden">
                        <img src="${p.img}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                        ${state.selectedProduct?.id === p.id ? 
                            '<div class="absolute inset-0 border-[3px] border-blue-600 z-10"></div>' : ''}
                    </div>
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-[10px] uppercase font-bold tracking-wider truncate w-24">${p.name}</h4>
                            <span class="mono text-[9px] text-gray-500">$${p.price}</span>
                        </div>
                        ${state.selectedProduct?.id === p.id ? '<i data-lucide="check" class="w-3 h-3 text-blue-600"></i>' : ''}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.selectProduct = function(id) {
            state.selectedProduct = PRODUCTS.find(p => p.id === id);
            renderProducts();
            
            els.summary.classList.remove('hidden');
            els.sumImg.src = state.selectedProduct.img;
            els.sumName.textContent = state.selectedProduct.name;
            els.sumPrice.textContent = `$${state.selectedProduct.price}`;
            
            checkReadiness();
        }

        function checkReadiness() {
            if (state.userImg && state.selectedProduct) {
                els.configPanel.classList.remove('opacity-50', 'pointer-events-none');
                els.emptyConfig.classList.add('hidden');
            }
        }

        function startSimulation() {
            if (state.isGenerating) return;
            state.isGenerating = true;

            // Create Loading Card
            const tempId = Date.now();
            const outputHTML = `
                <div id="gen-${tempId}" class="relative bg-gray-50 border border-gray-200 aspect-[3/4] overflow-hidden flex flex-col items-center justify-center p-6 fade-in">
                    <div class="scan-line"></div>
                    <div class="mono text-xs animate-pulse mb-2">GENERATING...</div>
                    <div class="w-32 h-1 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-600 animate-[loading_2s_ease-in-out_infinite]"></div>
                    </div>
                    <div class="mt-4 text-[9px] mono text-gray-400">
                        ${state.mode === 'image' ? 'DIFFUSION PIPELINE' : 'TEMPORAL CONSISTENCY CHECK'}
                    </div>
                </div>
            `;
            els.outputStream.insertAdjacentHTML('afterbegin', outputHTML);
            
            // Simulation
            const duration = state.mode === 'image' ? 3000 : 6000;
            
            setTimeout(() => {
                const container = document.getElementById(`gen-${tempId}`);
                const resultUrl = state.mode === 'image' 
                    ? "https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=600&auto=format&fit=crop&q=60"
                    : "https://videos.pexels.com/video-files/3205809/3205809-hd_1920_1080_25fps.mp4";

                const co2 = state.mode === 'image' ? '2.4g' : '15.1g';
                const energy = state.mode === 'image' ? '1200J' : '8500J';

                let content = '';
                if (state.mode === 'image') {
                    content = `<img src="${resultUrl}" class="w-full h-full object-cover">`;
                } else {
                    content = `<video src="${resultUrl}" autoplay loop muted class="w-full h-full object-cover"></video>`;
                }

                container.className = "relative bg-white border border-gray-200 shadow-sm fade-in";
                container.innerHTML = `
                    <div class="aspect-[3/4] relative group">
                        ${content}
                        <div class="absolute top-2 right-2 flex gap-1">
                             <span class="bg-black text-white text-[9px] mono px-1 py-0.5">${state.mode.toUpperCase()}</span>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-white/95 border-t border-gray-100 p-3">
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="serif italic text-sm">${state.selectedProduct.name}</div>
                                    <div class="flex gap-2 mt-1 mono text-[9px] text-gray-500">
                                        <span class="flex items-center gap-1"><i data-lucide="leaf" class="w-2 h-2"></i> ${co2}</span>
                                        <span class="flex items-center gap-1"><i data-lucide="zap" class="w-2 h-2"></i> ${energy}</span>
                                    </div>
                                </div>
                                <button class="text-[9px] mono underline hover:text-blue-600">BUY NOW</button>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                state.isGenerating = false;
                
                // Trigger Gemini prompt
                els.geminiPanel.classList.remove('hidden');
                els.geminiContent.innerHTML = `<span class="italic text-gray-400">Analysis ready for ${state.mode.toUpperCase()} generation...</span>`;

            }, duration);
        }

        async function callGemini() {
            const apiKey = els.apiKey.value;
            if (!apiKey) {
                els.geminiContent.innerHTML = "<span class='text-red-600 font-bold'>Error: Missing API Key in Header</span>";
                return;
            }

            els.geminiContent.innerHTML = "<span class='animate-pulse text-blue-500'>Computing aesthetics...</span>";
            els.askGeminiBtn.disabled = true;

            const userB64 = state.userImg.split(',')[1];
            
            const prompt = `
                Role: Technical Fashion Analyst.
                Task: Analyze the fit and style.
                Product: ${state.selectedProduct.name}.
                Format: 3 short bullet points (Fit, Style, Eco-Impact).
                Language: Portuguese.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: "image/jpeg", data: userB64 } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Analysis Failed.";
                
                els.geminiContent.innerHTML = `<div class="prose prose-sm">${text.replace(/\n/g, '<br>')}</div>`;

            } catch (err) {
                els.geminiContent.textContent = "AI Service Unavailable.";
            } finally {
                els.askGeminiBtn.disabled = false;
            }
        }
    </script>
    <style>
        @keyframes loading {
            0% { width: 0%; margin-left: 0; }
            50% { width: 100%; margin-left: 0; }
            100% { width: 0%; margin-left: 100%; }
        }
    </style>
</body>
</html>